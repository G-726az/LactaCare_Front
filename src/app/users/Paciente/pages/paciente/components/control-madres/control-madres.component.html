<div class="layout">
  <main class="content">

    <h2 class="panel-title">Control de Extracciones</h2>

    <!-- --------------------------------------------------------- -->
    <!-- üìä TARJETAS DE RESUMEN                                    -->
    <!-- --------------------------------------------------------- -->
    <div class="top-cards">
      <div class="card total-card hoverable">
        <p class="label">Total Disponible</p>
        <h3 class="value">{{ totalML }} ml</h3>
      </div>
      <div class="card caducar-card hoverable">
        <p class="label warning">‚ö† Por Caducar</p>
        <h3 class="value warning-text">{{ porCaducarML }} ml</h3>
      </div>
      <div class="card por-retirar-card hoverable" (click)="aplicarFiltro('Por Retirar')">
        <p class="label">‚è≥ Por Retirar</p>
        <h3 class="value">{{ porRetirarML }} ml</h3>
      </div>
      <div class="card usado-card hoverable" (click)="aplicarFiltro('Retirada')">
        <p class="label">üì¶ Retirados</p>
        <h3 class="value">{{ retiradosML }} ml</h3>
      </div>
    </div>

    <!-- --------------------------------------------------------- -->
    <!-- üîç FILTROS                                                -->
    <!-- --------------------------------------------------------- -->
    <div class="filters">
      <button class="filter-btn" [class.active]="filtroActivo === 'Todo'" (click)="aplicarFiltro('Todo')">Todo</button>
      <button class="filter-btn" [class.active]="filtroActivo === 'Refrigerada'" (click)="aplicarFiltro('Refrigerada')">Refrigerada</button>
      <button class="filter-btn" [class.active]="filtroActivo === 'Por Caducar'" (click)="aplicarFiltro('Por Caducar')">Por Caducar</button>
      <button class="filter-btn filter-por-retirar" [class.active]="filtroActivo === 'Por Retirar'" (click)="aplicarFiltro('Por Retirar')">Por Retirar</button>
      <button class="filter-btn filter-retirados" [class.active]="filtroActivo === 'Retirada'" (click)="aplicarFiltro('Retirada')">Retirados</button>
    </div>

    <!-- --------------------------------------------------------- -->
    <!-- üìã PANEL DE EXTRACCIONES (Grid adaptable)                 -->
    <!-- --------------------------------------------------------- -->
    <div class="extractions-panel" *ngIf="!loading">
      
      <!-- Mensaje cuando no hay extracciones -->
      <div *ngIf="extraccionesFiltradas.length === 0" class="empty-state">
        <div class="empty-icon">üì¶</div>
        <p class="empty-message">No hay extracciones {{ filtroActivo === 'Todo' ? 'registradas' : 'en esta categor√≠a' }}</p>
      </div>

      <!-- Lista de extracciones -->
      <div *ngFor="let ext of extraccionesFiltradas" 
           class="milk-card hoverable"
           [class.refrigerada]="ext.tipo === 'Refrigerada' && ext.estado === 'activa'"
           [class.caducar]="ext.tipo === 'Por Caducar' && ext.estado === 'activa'"
           [class.por-retirar]="ext.estado === 'por-retirar'"
           [class.caducada]="ext.estado === 'retirada'">
        
        <!-- Bot√≥n de cancelar (solo para "por-retirar") -->
        <button 
          *ngIf="ext.estado === 'por-retirar'" 
          class="btn-cancelar-retiro"
          (click)="abrirConfirmacionCancelacion(ext.id!, $event)"
          title="Cancelar retiro">
          ‚úï
        </button>

        <div class="icon-area">
          <img 
            [src]="ext.estado === 'retirada' ? 'https://imgur.com/9x7KqYr.png' : 
                  ext.estado === 'por-retirar' ? 'https://imgur.com/VkZTBxM.png' :
                  ext.tipo === 'Refrigerada' ? 'https://imgur.com/OLZBxEV.png' : 
                  'https://imgur.com/gYhFstu.png'" 
            [alt]="ext.tipo" 
          />
        </div>
        
        <div class="info">
          <p class="amount">{{ ext.cantidad }} ml</p>
          <p class="date">{{ ext.fecha | date:'short':'':'es-ES' }}</p>
          
          <!-- Badge seg√∫n estado -->
          <p class="estado-badge" *ngIf="ext.estado === 'retirada'">‚ùå Retirado</p>
          <p class="estado-badge badge-por-retirar" *ngIf="ext.estado === 'por-retirar'">‚è≥ Por Retirar (24h)</p>
          
          <p class="dias-caducidad" *ngIf="ext.estado === 'activa' && ext.diasHastaCaducidad !== undefined">
            <span *ngIf="ext.diasHastaCaducidad > 0">üìÖ {{ ext.diasHastaCaducidad }} d√≠a(s)</span>
            <span *ngIf="ext.diasHastaCaducidad <= 0" class="urgente">‚ö†Ô∏è ¬°Caduca hoy!</span>
          </p>
        </div>
        
        <div class="status" 
             [class.status-green]="ext.tipo === 'Refrigerada' && ext.estado === 'activa'"
             [class.status-orange]="ext.tipo === 'Por Caducar' && ext.estado === 'activa'"
             [class.status-yellow]="ext.estado === 'por-retirar'"
             [class.status-gray]="ext.estado === 'retirada'"></div>
      </div>
    </div>

    <!-- Loader -->
    <div *ngIf="loading" class="loading-spinner">
      <div class="spinner"></div>
      <p>Cargando extracciones...</p>
    </div>

    <!-- --------------------------------------------------------- -->
    <!-- ‚ûï BOT√ìN DE ACCI√ìN (SOLO RETIRAR)                          -->
    <!-- --------------------------------------------------------- -->
    <div class="action-buttons">
      <!-- Bot√≥n para retirar contenedores -->
      <button 
        class="btn-retirar-contenedores" 
        (click)="abrirPanelRetiroContenedores()"
        [disabled]="extraccionesDisponibles.length === 0"
        title="Retirar contenedores">
        üì¶ Marcar para Retiro
        <span class="badge-count" *ngIf="extraccionesDisponibles.length > 0">
          {{ extraccionesDisponibles.length }}
        </span>
      </button>
    </div>

  </main>
</div>

<!-- ========================================================== -->
<!-- MARCAR CONTENEDORES PARA RETIRO (SELECCI√ìN M√öLTIPLE)      -->
<!-- ========================================================== -->
<div class="modal-overlay" *ngIf="mostrarPanelRetiro" (click)="cerrarPanelRetiro()">
  <div class="modal-panel panel-uso" (click)="$event.stopPropagation()">
    
    <div class="modal-header">
      <h3>üì¶ Seleccionar Contenedores para Retiro</h3>
      <button class="close-btn" (click)="cerrarPanelRetiro()">&times;</button>
    </div>

    <div class="modal-body">
      
      <!-- Informaci√≥n -->
      <div class="info-box warning-box">
        <div class="info-icon">‚ö†Ô∏è</div>
        <div class="info-content">
          <h4>Importante</h4>
          <p>Los contenedores seleccionados se marcar√°n como <strong>POR RETIRAR</strong>. 
          En 24 horas se marcar√°n autom√°ticamente como <strong>RETIRADOS</strong> y el m√©dico recibir√° una notificaci√≥n.</p>
        </div>
      </div>

      <!-- Lista de contenedores disponibles -->
      <div class="contenedores-lista">
        <div class="lista-header">
          <h4>Contenedores Disponibles ({{ extraccionesDisponibles.length }})</h4>
          <div class="seleccion-acciones">
            <button class="btn-link" (click)="seleccionarTodos()" *ngIf="!todoSeleccionado">
              ‚úì Seleccionar todos
            </button>
            <button class="btn-link" (click)="deseleccionarTodos()" *ngIf="todoSeleccionado">
              ‚úó Deseleccionar todos
            </button>
          </div>
        </div>

        <!-- Items seleccionables -->
        <div class="contenedor-item" 
             *ngFor="let ext of extraccionesDisponibles"
             [class.selected]="estaSeleccionado(ext.id!)"
             (click)="toggleSeleccion(ext.id!)">
          
          <div class="checkbox-container">
            <input 
              type="checkbox" 
              [checked]="estaSeleccionado(ext.id!)"
              (click)="$event.stopPropagation()"
              (change)="toggleSeleccion(ext.id!)"
            />
          </div>

          <div class="contenedor-icon">
            <img 
              [src]="ext.tipo === 'Refrigerada' ? 'https://imgur.com/OLZBxEV.png' : 'https://imgur.com/gYhFstu.png'" 
              alt="Contenedor" 
            />
          </div>

          <div class="contenedor-info">
            <p class="contenedor-cantidad">{{ ext.cantidad }} ml</p>
            <p class="contenedor-fecha">{{ ext.fecha | date:'short':'':'es-ES' }}</p>
            <span class="contenedor-badge" [ngClass]="'badge-' + ext.tipo.toLowerCase().replace(' ', '-')">
              {{ ext.tipo }}
            </span>
          </div>

          <div class="contenedor-caducidad">
            <span *ngIf="ext.diasHastaCaducidad && ext.diasHastaCaducidad > 0">
              üìÖ {{ ext.diasHastaCaducidad }} d√≠a(s)
            </span>
            <span *ngIf="ext.diasHastaCaducidad && ext.diasHastaCaducidad <= 0" class="urgente">
              ‚ö†Ô∏è ¬°Caduca hoy!
            </span>
          </div>

        </div>

        <!-- Estado vac√≠o -->
        <div *ngIf="extraccionesDisponibles.length === 0" class="empty-state-small">
          <p>üì¶ No hay contenedores disponibles para marcar</p>
        </div>
      </div>

      <!-- Resumen de selecci√≥n -->
      <div class="seleccion-resumen" *ngIf="contenedoresSeleccionados.length > 0">
        <div class="resumen-content">
          <span class="resumen-label">Seleccionados:</span>
          <span class="resumen-valor">{{ contenedoresSeleccionados.length }} contenedor(es)</span>
          <span class="resumen-total">{{ totalMLSeleccionados }} ml</span>
        </div>
      </div>

    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="cerrarPanelRetiro()">Cancelar</button>
      <button 
        class="btn-confirmar" 
        (click)="confirmarRetiroContenedores()" 
        [disabled]="contenedoresSeleccionados.length === 0 || loading">
        <span *ngIf="!loading">‚úì Confirmar Retiro ({{ contenedoresSeleccionados.length }})</span>
        <span *ngIf="loading">Procesando...</span>
      </button>
    </div>

  </div>
</div>

<!-- ========================================================== -->
<!-- ‚ö†Ô∏è MODAL: CONFIRMACI√ìN DE RETIRO                           -->
<!-- ========================================================== -->
<div class="modal-overlay" *ngIf="mostrarConfirmacionRetiro" (click)="cancelarConfirmacion()">
  <div class="modal-panel modal-confirmacion" (click)="$event.stopPropagation()">
    
    <div class="modal-header warning">
      <h3>‚ö†Ô∏è Confirmar Marcado para Retiro</h3>
    </div>

    <div class="modal-body">
      
      <div class="confirmacion-warning">
        <div class="warning-icon-large">‚è≥</div>
        <h4>¬øEst√°s segura de marcar estos contenedores para retiro?</h4>
        <p>Has seleccionado <strong>{{ contenedoresSeleccionados.length }}</strong> contenedor(es) con un total de <strong>{{ totalMLSeleccionados }} ml</strong>.</p>
      </div>

      <div class="info-box danger-box">
        <ul class="warning-list">
          <li>‚úì Los contenedores se marcar√°n como <strong>POR RETIRAR</strong></li>
          <li>‚úì En 24 horas se marcar√°n autom√°ticamente como <strong>RETIRADOS</strong></li>
          <li>‚úì El m√©dico recibir√° notificaciones del proceso</li>
          <li>‚úì Podr√°s cancelar el retiro antes de las 24 horas</li>
          <li>‚úì Podr√°s ver el historial en la secci√≥n "Retirados"</li>
        </ul>
      </div>

      <div class="contenedores-confirmacion">
        <h5>Contenedores a marcar:</h5>
        <ul class="lista-confirmacion">
          <li *ngFor="let id of contenedoresSeleccionados">
            {{ obtenerExtraccionPorId(id)?.cantidad }} ml - 
            {{ obtenerExtraccionPorId(id)?.tipo }} - 
            {{ obtenerExtraccionPorId(id)?.fecha | date:'short':'':'es-ES' }}
          </li>
        </ul>
      </div>

    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="cancelarConfirmacion()">‚ùå Cancelar</button>
      <button class="btn-danger" (click)="ejecutarRetiroContenedores()" [disabled]="loading">
        <span *ngIf="!loading">‚úì S√≠, marcar para retiro</span>
        <span *ngIf="loading">Procesando...</span>
      </button>
    </div>

  </div>
</div>

<!-- ========================================================== -->
<!-- ‚ö†Ô∏è MODAL: CONFIRMAR CANCELACI√ìN DE RETIRO                 -->
<!-- ========================================================== -->
<div class="modal-overlay" *ngIf="mostrarConfirmacionCancelacion" (click)="cerrarConfirmacionCancelacion()">
  <div class="modal-panel modal-confirmacion" (click)="$event.stopPropagation()">
    
    <div class="modal-header warning">
      <h3>‚ö†Ô∏è Confirmar Cancelaci√≥n de Retiro</h3>
    </div>

    <div class="modal-body">
      
      <div class="confirmacion-warning">
        <div class="warning-icon-large">‚ùì</div>
        <h4>¬øEst√°s segura de cancelar el retiro?</h4>
        <p>El contenedor volver√° a su estado original y estar√° disponible nuevamente.</p>
      </div>

      <div class="info-box warning-box">
        <ul class="warning-list">
          <li>‚úì El contenedor volver√° al inventario disponible</li>
          <li>‚úì Se cancelar√° el proceso de retiro</li>
          <li>‚úì Podr√°s marcarlo nuevamente si lo deseas</li>
        </ul>
      </div>

    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="cerrarConfirmacionCancelacion()">No, mantener retiro</button>
      <button class="btn-danger" (click)="ejecutarCancelacionRetiro()" [disabled]="loading">
        <span *ngIf="!loading">‚úì S√≠, cancelar retiro</span>
        <span *ngIf="loading">Procesando...</span>
      </button>
    </div>

  </div>
</div>