<div class="lactarios-container">
  <!-- ========== FORMULARIO DE SALA (MODAL) ========== -->
  @if (mostrarFormularioSala) {
  <div class="modal-overlay-form" (click)="cerrarFormularioSala()">
    <div class="modal-content-form" (click)="$event.stopPropagation()">
      <div class="form-header">
        <h2>{{ modoEdicionSala ? '‚úèÔ∏è Editar' : '‚ûï Nueva' }} Sala de Lactancia</h2>
        <button class="btn-close-modal" (click)="cerrarFormularioSala()">‚úñ</button>
      </div>

      <div class="form-split">
        <!-- MITAD IZQUIERDA -->
        <div class="form-left">
          <div class="form-group">
            <label for="nombre">Nombre *</label>
            <input
              type="text"
              id="nombre"
              [(ngModel)]="salaActual.nombreCMedico"
              placeholder="Ej: Lactario Hospital Central"
            />
          </div>

          <div class="form-group">
            <label for="direccion">Direcci√≥n *</label>
            <input
              type="text"
              id="direccion"
              [(ngModel)]="salaActual.direccionCMedico"
              placeholder="Ej: Av. Principal 123"
            />
          </div>

          <div class="form-group">
            <label for="correo">Correo *</label>
            <input
              type="email"
              id="correo"
              [(ngModel)]="salaActual.correoCMedico"
              placeholder="lactario@ejemplo.com"
            />
          </div>

          <div class="form-group">
            <label for="telefono">Tel√©fono *</label>
            <input
              type="tel"
              id="telefono"
              [(ngModel)]="salaActual.telefonoCMedico"
              placeholder="+593 99 123 4567"
            />
          </div>

          <div class="form-group">
            <label>Horario</label>
            <div class="horario-grid">
              <div class="horario-item">
                <label class="sublabel">Apertura</label>
                <input type="time" [(ngModel)]="salaActual.horarioSala!.horaApertura" />
              </div>
              <div class="horario-item">
                <label class="sublabel">Cierre</label>
                <input type="time" [(ngModel)]="salaActual.horarioSala!.horaCierre" />
              </div>
              <div class="horario-item">
                <label class="sublabel">Inicio Descanso</label>
                <input type="time" [(ngModel)]="salaActual.horarioSala!.horaInicioDescanso" />
              </div>
              <div class="horario-item">
                <label class="sublabel">Fin Descanso</label>
                <input type="time" [(ngModel)]="salaActual.horarioSala!.horaFinDescanso" />
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>D√≠as Laborables</label>
            <div class="dias-list-horizontal">
              <label class="dia-checkbox">
                <input type="checkbox" [(ngModel)]="salaActual.diasLaborablesSala!.diaLunes" />
                <span>Lunes</span>
              </label>
              <label class="dia-checkbox">
                <input type="checkbox" [(ngModel)]="salaActual.diasLaborablesSala!.diaMartes" />
                <span>Martes</span>
              </label>
              <label class="dia-checkbox">
                <input type="checkbox" [(ngModel)]="salaActual.diasLaborablesSala!.diaMiercoles" />
                <span>Mi√©rcoles</span>
              </label>
              <label class="dia-checkbox">
                <input type="checkbox" [(ngModel)]="salaActual.diasLaborablesSala!.diaJueves" />
                <span>Jueves</span>
              </label>
              <label class="dia-checkbox">
                <input type="checkbox" [(ngModel)]="salaActual.diasLaborablesSala!.diaViernes" />
                <span>Viernes</span>
              </label>
              <label class="dia-checkbox">
                <input type="checkbox" [(ngModel)]="salaActual.diasLaborablesSala!.diaSabado" />
                <span>S√°bado</span>
              </label>
              <label class="dia-checkbox">
                <input type="checkbox" [(ngModel)]="salaActual.diasLaborablesSala!.diaDomingo" />
                <span>Domingo</span>
              </label>
            </div>
          </div>

          <div class="form-group">
            <label for="cubiculos">N√∫mero de Cub√≠culos</label>
            <div class="number-input-narrow">
              <input
                type="number"
                id="cubiculos"
                [(ngModel)]="numeroCubiculos"
                min="0"
                max="50"
                [disabled]="modoEdicionSala"
              />
              <div class="number-buttons">
                <button
                  type="button"
                  class="btn-increment"
                  (click)="incrementarCubiculos()"
                  [disabled]="modoEdicionSala"
                >
                  ‚ñ≤
                </button>
                <button
                  type="button"
                  class="btn-decrement"
                  (click)="decrementarCubiculos()"
                  [disabled]="modoEdicionSala"
                >
                  ‚ñº
                </button>
              </div>
            </div>
            @if (modoEdicionSala) {
            <small class="info-text">‚ö†Ô∏è No se puede modificar en modo edici√≥n</small>
            }
          </div>
        </div>

        <!-- MITAD DERECHA -->
        <div class="form-right">
          <div class="form-group">
            <label for="estado">Estado *</label>
            <select id="estado" [(ngModel)]="salaActual.estado">
              <option value="">SELECCIONE</option>
              <option value="ACTIVO">ACTIVO</option>
              <option value="INACTIVO">INACTIVO</option>
            </select>
          </div>

          <div class="form-group">
            <label for="institucion">Instituci√≥n *</label>
            <select id="institucion" [(ngModel)]="institucionSeleccionada">
              <option value="0">Seleccione una instituci√≥n</option>
              @for (inst of instituciones; track inst.idInstitucion) {
              <option [value]="inst.idInstitucion">{{ inst.nombreInstitucion }}</option>
              }
            </select>
          </div>

          <div class="form-group">
            <label>Ubicaci√≥n</label>
            <div class="ubicacion-inputs">
              <div class="coord-input">
                <label class="sublabel">Latitud (X)</label>
                <input
                  type="text"
                  [(ngModel)]="salaActual.latitudCMedico"
                  (change)="onCoordinateChange()"
                  placeholder="-2.1894"
                />
              </div>
              <div class="coord-input">
                <label class="sublabel">Longitud (Y)</label>
                <input
                  type="text"
                  [(ngModel)]="salaActual.longitudCMedico"
                  (change)="onCoordinateChange()"
                  placeholder="-79.8886"
                />
              </div>
            </div>
          </div>

          <div class="map-container">
            <div id="map"></div>
            <small class="map-hint"
              >üí° Haz clic en el mapa o arrastra el marcador para cambiar la ubicaci√≥n</small
            >
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="cerrarFormularioSala()">
              ‚Üê Cancelar
            </button>
            <button type="button" class="btn-save" (click)="guardarSala()">üíæ Guardar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- ========== SECCI√ìN INSTITUCIONES ========== -->
  <div class="section-header">
    <h2>Gesti√≥n de Instituciones</h2>
    <div class="header-buttons">
      <button class="btn-secondary-header" (click)="abrirModalInstitucion()">
        üè¢ Nueva Instituci√≥n
      </button>
    </div>
  </div>

  <div class="row row-cols-1 row-cols-md-3 g-4">
    @if (loadingInstitucion) { @for (item of [1,2,3]; track item) {
    <div class="col">
      <div class="card h-100" style="width: 18rem">
        <div class="placeholder-glow">
          <div class="placeholder card-img-top" style="height: 180px"></div>
        </div>
        <div class="card-body">
          <span class="placeholder col-8"></span>
        </div>
        <div class="card-footer">
          <span class="placeholder col-3 me-2"></span>
          <span class="placeholder col-3"></span>
        </div>
      </div>
    </div>
    } } @else if (instituciones.length === 0) {
    <div class="empty-state">
      <p>üìã No se encontraron instituciones</p>
      <button class="btn-primary" (click)="abrirModalInstitucion()">
        Crear primera instituci√≥n
      </button>
    </div>
    } @else { @for (institucion of instituciones; track institucion.idInstitucion) {
    <div class="col">
      <div class="institucion-card h-100" style="width: 18rem">
        <img
          [src]="
            institucion.logoInstitucion
              ? 'data:image/png;base64,' + institucion.logoInstitucion
              : defaultImage
          "
          alt="Logo"
          width="280"
          (error)="onImageError($event)"
        />

        <div class="card-body">
          {{ institucion.nombreInstitucion }}
        </div>
        <div class="card-footer border-secondary">
          <button class="btn-icon" title="Editar" (click)="editarInstitucion(institucion)">
            ‚úèÔ∏è
          </button>
          <button
            class="btn-icon"
            title="Eliminar"
            (click)="eliminarInstitucion(institucion.idInstitucion)"
          >
            üóëÔ∏è
          </button>
        </div>
      </div>
    </div>
    } }
  </div>

  <!-- ========== SECCI√ìN SALAS DE LACTANCIA ========== -->
  <div class="section-header" style="margin-top: 2rem">
    <h2>Gesti√≥n de Salas de Lactancia</h2>
    <button class="btn-primary" (click)="abrirFormularioNuevo()">‚ûï Nueva Sala de Lactancia</button>
  </div>

  <!-- FILTROS -->
  <div class="filtros-section">
    <input
      type="text"
      placeholder="üîç Buscar sala..."
      [(ngModel)]="busqueda"
      (input)="filtrarLactarios()"
      aria-label="Buscar sala"
    />
    <select
      [(ngModel)]="estadoFiltro"
      (change)="filtrarLactarios()"
      aria-label="Filtrar por estado"
    >
      <option value="">Todos los estados</option>
      <option value="ACTIVO">Activo</option>
      <option value="INACTIVO">Inactivo</option>
    </select>
  </div>

  <!-- LOADING LACTARIOS -->
  @if (loadingLactarios) {
  <div class="loading-container">
    <div class="spinner"></div>
    <p>Cargando salas de lactancia...</p>
  </div>
  } @else if (lactariosFiltrados.length === 0) {
  <div class="empty-state">
    <p>üìã No se encontraron salas de lactancia</p>
    <button class="btn-primary" (click)="abrirFormularioNuevo()">Crear primera sala</button>
  </div>
  } @else {
  <!-- GRID DE LACTARIOS -->
  <div class="lactarios-grid">
    @for (lactario of lactariosFiltrados; track lactario.idLactario) {
    <div class="lactario-card">
      <div
        class="card-header"
        [class.activo]="lactario.estado === 'ACTIVO'"
        [class.inactivo]="lactario.estado === 'INACTIVO'"
      >
        <h3>{{ lactario.nombreCMedico }}</h3>
        <span class="estado-badge" [class.activo]="lactario.estado === 'ACTIVO'">
          {{ lactario.estado }}
        </span>
      </div>

      <div class="card-body">
        <div class="info-item">
          <span class="icon">üè¢</span>
          <span>{{ lactario.institucion?.nombreInstitucion || 'Sin instituci√≥n' }}</span>
        </div>
        <div class="info-item">
          <span class="icon">üìç</span>
          <span>{{ lactario.direccionCMedico }}</span>
        </div>
        <div class="info-item">
          <span class="icon">üìû</span>
          <span>{{ lactario.telefonoCMedico }}</span>
        </div>
        <div class="info-item">
          <span class="icon">üìß</span>
          <span>{{ lactario.correoCMedico }}</span>
        </div>
        <div class="info-item">
          <span class="icon">üö™</span>
          <span>{{ lactario.cubiculos?.length || 0 }} Cub√≠culos</span>
        </div>
        <div class="info-item">
          <span class="icon">üìÖ</span>
          <span>{{ obtenerDiasLaborables(lactario) }}</span>
        </div>
      </div>

      <div class="card-footer">
        <button class="btn-icon" (click)="verDetalles(lactario)" title="Ver detalles">üëÅÔ∏è</button>
        <button class="btn-icon" (click)="editarLactario(lactario.idLactario!)" title="Editar">
          ‚úèÔ∏è
        </button>
        <button
          class="btn-icon"
          (click)="cambiarEstadoLactario(lactario)"
          [title]="lactario.estado === 'ACTIVO' ? 'Desactivar' : 'Activar'"
        >
          {{ lactario.estado === 'ACTIVO' ? 'üî¥' : 'üü¢' }}
        </button>
        <button class="btn-icon" (click)="eliminarLactario(lactario.idLactario!)" title="Eliminar">
          üóëÔ∏è
        </button>
      </div>
    </div>
    }
  </div>
  }

  <!-- ========== MODAL NUEVA INSTITUCI√ìN ========== -->
  @if (mostrarModalInstitucion) {
  <div class="modal-overlay" (click)="cerrarModalInstitucion()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>üè¢ {{ modoEdicionInstitucion ? 'Editar' : 'Nueva' }} Instituci√≥n</h3>
      <div class="form-group">
        <label for="nombreInstitucion">Nombre de la Instituci√≥n *</label>
        <input
          name="nombreInstitucion"
          type="text"
          [(ngModel)]="institucionActual.nombreInstitucion"
          placeholder="Ej: Hospital General"
        />
        <label for="logoUrl">URL del Logo (debe terminar en .png) *</label>
        <input
          id="logoUrl"
          type="url"
          [(ngModel)]="institucionActual.logoInstitucion"
          placeholder="https://ejemplo.com/logo"
        />
        @if (logoUrl) {
        <div class="logo-preview">
          <p><strong>Vista previa del logo:</strong></p>
          <img
            [src]="logoUrl + '.png'"
            alt="Vista previa del logo"
            (error)="onImageError($event)"
            style="
              max-width: 200px;
              max-height: 200px;
              border: 2px solid #ddd;
              border-radius: 8px;
              padding: 10px;
            "
          />
        </div>
        }
      </div>

      <div class="modal-actions">
        <button class="btn-secondary" (click)="cerrarModalInstitucion()">Cancelar</button>
        <button class="btn-primary" (click)="guardarInstitucion()">Guardar</button>
      </div>
    </div>
  </div>
  }
</div>
